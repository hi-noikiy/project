<extend name='Public/base'/>
<block name='title'>中瑞网售管理系统-商品列表</block>
<block name='body'>
    <div class="content">
        <div class="leftMenu">
            <ul>
                {$leftMenu}
            </ul>
            <div class="planBtn"><a class="button" href="javascript:getCinemaList();" >一键刷新排期</a></div>
        </div>
        <div class="rightContent">
        	<div class="queryBox">
            	<form>
				<div class="inputSelect">
                	<span>兑换方案状态：</span>
                	<select name=''>
                    	<option value="0">所有方案</option>
                        <option value="1">未设方案</option>
                        <option value="2">默认方案</option>
                     </select>
                </div>
                <div class="inputSelect">
                	<span>抵值方案状态：</span>
                	<select name=''>
                    	<option value="0">所有方案</option>
                        <option value="1">未设方案</option>
                        <option value="2">默认方案</option>
                     </select>
                </div>
                 <div class="inputSelect">
                	<span>按影院查询：</span>
                	<select name=''>
                    	<option value="0">厦门梦工坊</option>
                        <option value="1">厦门梦露</option>
                     </select>
                </div>
                <div class="inputSelect">
                	<span>按影片查询：</span>
                	<select name=''>
                    	<option value="0">所有影片</option>
                        <option value="1">碟中谍5</option>
                     </select>
                </div>
                <div class="inputText" >
                	<span>按影片排期日期查询：</span>
                    <input type="text" name="start" onclick="WdatePicker()" placeholder="请输入开始日期" value="{$pageData['start']}"><span>至</span>
                    <input type="text" name="end" onclick="WdatePicker()" placeholder="请输入结束日期" value="{$pageData['end']}">
                </div>
                <a href="#" class="button">查询</a>
                </form>
            </div>
            <div class="queryBox">
            	<form>
				<div class="inputSelect">
                	<span>兑换方案配置：</span>
                	<select name=''>
                    	<option value="0">所有方案</option>
                        <option value="1">未设方案</option>
                        <option value="2">默认方案</option>
                     </select>
                </div>
                <div class="inputSelect">
                	<span>抵值方案配置：</span>
                	<select name=''>
                    	<option value="0">所有方案</option>
                        <option value="1">未设方案</option>
                        <option value="2">默认方案</option>
                     </select>
                </div>
                <a href="#" class="button">选中应用方案</a>
                <a href="#" class="button">全部应用方案</a>
                </form>
            </div>
            <div class="tableList">
                <table width="100%" cellpadding="0" cellspacing="0" border="0">
                    <thead>
                      <tr >
                      	<td width="5%"><input type="checkbox" onclick="select_other(this);" /></td>
                        <td width="10%">排期编码</td>
                        <td width="10%">影院名称</td>
                        <td width="10%">影片名称</td>
                        <td width="8%">影片类型</td>
                        <td width="8%">排期日期</td>
                        <td width="6%">放映时间</td>
                        <td width="6%">结束时间</td>
                        <td width="8%">影厅名称</td>
                        <td width="5%">票券状态</td>
                        <td width="5%">售票状态</td>
                        <td width="8%">兑换方案</td>
                        <td width="8%">抵值方案</td>
                      </tr>
                    </thead>
                     <tbody>
                            <tr>
                            <td><input type="checkbox" name='id'  /></td>
                            <td> 12321312 </td>
                            <td> 梦工坊影城 </td>
                            <td>碟中谍 </td>
                            <td>3DImax</td>
                            <td>2015-09-25 </td>
                            <td> 22:00</td>
                            <td> 00:00 </td>
                            <td >2号厅</td>
                            <td >可用</td>
                            <td >开售</td>
                            <td > 默认方案 </td>
                            <td >未设置</td>
                            </tr>
                            <tr>
                            <td><input type="checkbox" name='id'  /></td>
                            <td> 12321312 </td>
                            <td> 梦工坊影城 </td>
                            <td>碟中谍 </td>
                            <td>3DImax</td>
                            <td>2015-09-25 </td>
                            <td> 22:00</td>
                            <td> 00:00 </td>
                            <td >2号厅</td>
                            <td >可用</td>
                            <td >开售</td>
                            <td > 默认方案 </td>
                            <td >未设置</td>
                            </tr>
                            <tr>
                            <td><input type="checkbox" name='id'  /></td>
                            <td> 12321312 </td>
                            <td> 梦工坊影城 </td>
                            <td>碟中谍 </td>
                            <td>3DImax</td>
                            <td>2015-09-25 </td>
                            <td> 22:00</td>
                            <td> 00:00 </td>
                            <td >2号厅</td>
                            <td >可用</td>
                            <td >开售</td>
                            <td > 默认方案 </td>
                            <td >未设置</td>
                            </tr>
                    </tbody>
                </table>
                <div class="pagination">
                
                <div class="page">
                    {$page}
                	
                </div>
                
            </div>
            </div>
        </div>
	</div>
<script type="text/javascript">
$('.queryBox .button').click(function(){
	$('#myform').submit();
});
//全选
function select_other(){
	    jQuery.each($("input[name='id']"), function(i, n){
	    n.checked = !n.checked;
	    }); 
	}


$(function(){
	var urlstr="?cinemaCode={$pageData['cinemaCode']}&filmNo={$pageData['filmNo']}&start={$pageData['start']}&end={$pageData['end']}";
	$('.page a').each(function(){
		$(this).attr('href',$(this).attr('href')+urlstr);
	});
});
//加载扩展模块
var loadi = '';
var loadimsg = '';  


function edit(featureAppNo){

    layer.open({
		   type: 2,   //0-4的选择,
			title: false,
			border: [0],
			closeBtn: [0],
			shadeClose: true,
			area: ['500px', '320px'],
			content: '{:U('planprice')}?featureAppNo=' + featureAppNo
		});
}

function del(featureAppNo){
		layer.confirm('确认是否删除？',function(index){

            loadi = layer.load(1, {shade: [0.5,'#000']});
            loadimsg = layer.msg('正在删除中...',{icon: 16, time:60000000});

                $.ajax({    
                url:'{:U("ajaxDelPlan")}',// 跳转到 action    
                data:{'featureAppNo':featureAppNo},    
                type:'post',       
                dataType:'json',    
                success:function(data) {
                    layer.close(loadi);
                    layer.close(loadimsg);
                   
                    if(data.status == 0){
                       layer.msg(data.content, {time: 1000});

                       location.reload();

                    }else{
                       layer.msg(data.content, {time: 1000});
                    }

                },    
                error : function() {
                    layer.close(loadi);
                    layer.close(loadimsg);
                    layer.msg('删除失败，请重试', {icon: 5});
                }    
            });
		
		})
	}

function getCinemaList () {
    loadi = layer.load(1, {shade: [0.5,'#000'], title: '开始刷新排期！'});
    layer.msg('正在获取影院列表...',{time: 3600});
    $.ajax({    
        url:'{:U("getCinemaList")}',// 跳转到 action    
        // data:{'groupName':groupName},    
        type:'post',       
        dataType:'json',    
        success:function(data) {
            if(data.status == 0){
                layer.msg('获取影院列表成功...',{time: 3600});
                getPlanList(data.data);
            }else{
                layer.alert(data.content, {icon: 5});
            }
        },    
        error : function() {
            layer.close(loadi);
            layer.alert('获取影院列表失败，请重试', {icon: 5});
        }    
    });
    // alert('开始刷新排期！');
}
var allCount = 0;
var isDo = 0;
function getPlanList (cinemas) {
    allCount = 0;
    isDo = 0;
    var upPlanDate = [{$upPlanDate}];
    $.each(upPlanDate, function(dateKey, dateValue) {
        $.each(cinemas, function(key, value) {
            layer.msg('开始获取' + value.cinemaName + '的排期！', {time: 3600});
            allCount ++;
            ajaxGetPlan(value.cinemaCode, value.cinemaName, dateValue);
        })
    })
}

function ajaxGetPlan (cinemaCode, cinemaName, planDate) {
    $.ajax({    
        url:'{:U("Refresh/Plan/getPlanList")}',// 跳转到 action    
        data:{'cinemaCode':cinemaCode,'planDate':planDate},    
        type:'post',       
        dataType:'json',    
        success:function(data) {
            layer.msg(data.content, {time: 3600});
            isDo++;
            if(isDo == allCount){
                layer.msg('恭喜您，所有影城刷新刷新完成！');
                layer.close(loadi);
                setTimeout(function(){location.reload()}, 1000);
            }

        },    
        error : function() {
            layer.close(loadi);
            layer.msg('获取影院列表失败，请重试', {icon: 5});
        }    
    });
}
</script> 
</block>